<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Agendamento | Studio Gabi Dummer</title>

<link rel="stylesheet" href="../css/estilo.css">

<style>
body{font-family:Arial;background:#fff0f6;margin:0}
.wrap{max-width:900px;margin:120px auto;padding:20px}
.card{background:#fff;border-radius:20px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
.slot{display:flex;justify-content:space-between;align-items:center;margin:10px 0;padding:12px;border:1px solid #eee;border-radius:14px}
.btn{background:#ff4fa3;border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:bold;cursor:pointer}
.badge{background:#ffe0ef;color:#d63384;padding:6px 10px;border-radius:999px;font-weight:bold}
</style>
</head>

<body>

<div class="wrap">
<div class="card">

<h2>Agendamento</h2>
<div id="status" class="badge">Carregando...</div>

<div id="lista"></div>

</div>
</div>

<script>

const WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbwluaTuD98C0SAgZmCqBtwZgq1D1rVWkpyyR6XqnmB2WCCoxzLUXixqhenUUwElqjk9/exec";

const lista = document.getElementById("lista");
const status = document.getElementById("status");

// JSONP (GitHub precisa disso)
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{delete window[cb];script.remove();resolve(data);};
    const script=document.createElement("script");
    script.src=url+"&callback="+cb;
    script.onerror=()=>reject("Erro ao carregar Apps Script");
    document.body.appendChild(script);
  });
}

async function carregar(){

  status.textContent="Carregando horários...";
  lista.innerHTML="";

  try{

    const res = await jsonp(WEBAPP_URL+"?action=list");

    if(!res.ok) throw "Erro ao listar";

    const slots = res.slots || [];

    if(!slots.length){
      status.textContent="Sem horários";
      return;
    }

    status.textContent = slots.length+" horários disponíveis";

    slots.forEach(s=>{

      const div=document.createElement("div");
      div.className="slot";

      div.innerHTML=`
        <div>
          <b>${s.data} • ${s.hora}</b><br>
          ${s.servico} — ${s.preco}
        </div>
        <button class="btn">RESERVAR</button>
      `;

      const btn=div.querySelector("button");

      btn.onclick=async()=>{

        btn.disabled=true;
        btn.textContent="Reservando...";

        try{

          const r=await jsonp(WEBAPP_URL+"?action=reserve&row="+s.row);

          if(!r.ok) throw "Erro ao reservar";

          div.remove();
          status.textContent="Reservado ✅";

        }catch(e){
          btn.disabled=false;
          btn.textContent="RESERVAR";
          alert(e);
        }
      };

      lista.appendChild(div);
    });

  }catch(err){
    status.textContent="Erro ao carregar";
    alert(err);
  }
}

carregar();

</script>

</body>
</html>
