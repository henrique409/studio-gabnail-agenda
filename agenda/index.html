const SPREADSHEET_ID = "1xifThuflyHX27K4PL8DRaJA6IMDzi_kj5URsUyh2nlo";
const SHEET_HORARIOS = "HORARIOS";

// Colunas na sua planilha (A..G):
// A Data | B Hora | C Servico | D Preco | E Status | F ReservarID | G ReservadoEm
const COL_DATA = 1;
const COL_HORA = 2;
const COL_SERVICO = 3;
const COL_PRECO = 4;
const COL_STATUS = 5;
const COL_RESERVA_ID = 6;
const COL_RESERVADO_EM = 7;

function getSheet_(){
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(SHEET_HORARIOS);
  if(!sh) throw new Error('Aba "HORARIOS" não encontrada.');
  return sh;
}

function doGet(e){
  const params = (e && e.parameter) ? e.parameter : {};
  const action = (params.action ? String(params.action) : "list").toLowerCase();

  try{
    if(action === "list"){
      return output_(listar_(), params);
    }

    if(action === "reserve"){
      const row = Number(params.row);
      if(!row || row < 2) return output_({ok:false, error:"Linha inválida."}, params);
      return output_(reservar_(row), params);
    }

    return output_({ok:false,error:"ação inválida"}, params);

  }catch(err){
    return output_({ok:false,error:String(err && err.message ? err.message : err)}, params);
  }
}

function listar_(){
  const sh = getSheet_();
  const lastRow = sh.getLastRow();
  if(lastRow < 2) return {ok:true, slots:[]};

  const values = sh.getRange(2, 1, lastRow - 1, 7).getValues();
  const tz = Session.getScriptTimeZone();

  const slots = [];

  values.forEach((r, i) => {
    const data = r[0];
    const hora = r[1];
    const servico = r[2];
    const preco = r[3];
    const status = String(r[4] || "").toUpperCase().trim();

    if(status !== "DISPONIVEL") return;

    // Formata data
    let dataFormatada = "";
    if(data instanceof Date && !isNaN(data.getTime())){
      dataFormatada = Utilities.formatDate(data, tz, "dd/MM/yyyy");
    } else {
      dataFormatada = String(data || "");
    }

    // Formata hora
    let horaFormatada = "";
    if(hora instanceof Date && !isNaN(hora.getTime())){
      horaFormatada = Utilities.formatDate(hora, tz, "HH:mm");
    } else {
      horaFormatada = String(hora || "").trim();
    }

    slots.push({
      row: i + 2,
      data: dataFormatada,
      hora: horaFormatada,
      servico: servico,
      preco: preco
    });
  });

  return {ok:true, slots};
}

function reservar_(row){
  // Trava para evitar 2 pessoas reservarem ao mesmo tempo
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);

  try{
    const sh = getSheet_();

    // Lê status atual da linha
    const statusCell = sh.getRange(row, COL_STATUS);
    const status = String(statusCell.getValue() || "").toUpperCase().trim();

    if(status !== "DISPONIVEL"){
      return {ok:false, error:"Este horário já foi reservado. Atualize a página."};
    }

    // Marca como reservado
    const reservaId = Utilities.getUuid();
    const agora = new Date();

    statusCell.setValue("RESERVADO");
    sh.getRange(row, COL_RESERVA_ID).setValue(reservaId);
    sh.getRange(row, COL_RESERVADO_EM).setValue(agora);

    return {ok:true, reservaId};

  } finally {
    lock.releaseLock();
  }
}

/**
 * JSONP para GitHub Pages:
 * se vier ?callback=nomeFunc -> devolve JavaScript: nomeFunc({...});
 * senão devolve JSON normal
 */
function output_(obj, params){
  const callback = params.callback ? String(params.callback).trim() : "";

  if(callback){
    const js = `${callback}(${JSON.stringify(obj)});`;
    return ContentService
      .createTextOutput(js)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
