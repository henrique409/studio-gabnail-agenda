<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agendamento | Studio Gabi Dummer</title>

  <link rel="icon" type="image/png" href="../img/favicon.png" />
  <link rel="stylesheet" href="../css/estilo.css" />

  <style>
    .wrap{max-width:1100px;margin:110px auto 50px;padding:0 18px;}
    .card{background:#fff;border-radius:22px;padding:22px;box-shadow:0 14px 35px rgba(0,0,0,.08);}
    .titulo{margin:0 0 6px;font-size:28px;color:#d63384;}
    .sub{margin:0 0 14px;opacity:.85;line-height:1.35}
    .top-mini{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap;}
    .badge{display:inline-block;background:#ffe0ef;color:#d63384;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;}
    .acoes{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

    .btn{
      display:inline-block;border:0;border-radius:14px;padding:10px 14px;
      font-weight:900;cursor:pointer;text-decoration:none;
      background:#ff4fa3;color:#fff;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .btn-sec{background:#ffe0ef;color:#d63384;font-weight:900;}
    .btn-mini{padding:8px 12px;border-radius:12px;font-weight:900;}

    .grid{display:grid;gap:12px;margin-top:14px;}
    .slot{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:14px;border:1px solid rgba(0,0,0,.08);border-radius:16px;
    }
    .slot b{display:block}
    .slot small{opacity:.8}

    .msg{font-size:13px;opacity:.8;line-height:1.35;margin-top:10px}
    .erro{background:#fff3f3;border:1px solid rgba(255,0,0,.12);padding:12px;border-radius:14px;color:#b00020}
    .ok{background:#f3fff7;border:1px solid rgba(0,128,0,.12);padding:12px;border-radius:14px;color:#0a6b2b}

    .linha{height:1px;background:rgba(0,0,0,.06);margin:14px 0;}

    /* ‚úÖ Calend√°rio simples */
    .filtro-data{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .filtro-data label{
      font-size:13px;
      font-weight:900;
      opacity:.9;
    }
    .filtro-data input[type="date"]{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      outline:none;
    }
    .filtro-data input[type="date"]:focus{
      border-color:rgba(214,51,132,.5);
      box-shadow:0 0 0 4px rgba(214,51,132,.12);
    }

    iframe{
      width:100%;height:900px;border:0;border-radius:16px;overflow:hidden;
    }
    @media(max-width:900px){ iframe{height:980px;} }
  </style>
</head>

<body>

<header class="topo">
  <div class="topo-container">
    <a class="brand" href="../#topo">
      <img src="../img/logo.png" alt="Studio Gabi Dummer" />
      <span class="nome-studio">studio.gabidummer.nails</span>
    </a>

    <nav class="topo-links">
      <a class="link-icone" href="../" style="text-decoration:none;">
        <span class="badge">Voltar</span>
      </a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="top-mini">
    <div>
      <h1 class="titulo">Agendamento</h1>
      <p class="sub">
        1) Escolha uma <b>DATA</b> no calend√°rio üìÖ<br>
        2) Escolha um hor√°rio dispon√≠vel e clique em <b>RESERVAR</b> ‚úÖ<br>
        3) Depois preencha o formul√°rio para confirmar seu atendimento.
      </p>

      <!-- ‚úÖ NOVO: calend√°rio simples -->
      <div class="filtro-data">
        <label for="dia">Selecione a data:</label>
        <input id="dia" type="date" />
        <span class="badge" id="diaBadge">Nenhuma data escolhida</span>
      </div>
    </div>

    <div class="acoes">
      <span class="badge" id="statusBadge">Carregando hor√°rios‚Ä¶</span>
      <button class="btn btn-sec btn-mini" id="btnAtualizar" type="button">Atualizar</button>
      <a class="btn btn-sec btn-mini" id="btnFormsTopo" target="_blank" rel="noopener noreferrer"
         href="https://docs.google.com/forms/d/e/1FAIpQLSe5UBt0En3aVGkGw4Oue4cdFE2oCK4YCTcUIjE7ySW7z7Wp4Q/viewform?usp=publish-editor">
        Abrir formul√°rio
      </a>
    </div>
  </div>

  <!-- LISTA DE HOR√ÅRIOS -->
  <section class="card">
    <div id="alerta" class="msg"></div>
    <div id="lista" class="grid"></div>

    <div class="linha"></div>

    <p class="msg">
      ‚è≥ Reserva expira em alguns minutos se o formul√°rio n√£o for preenchido.
    </p>
  </section>

  <!-- FORMUL√ÅRIO (embed) -->
  <div class="linha"></div>

  <div class="top-mini">
    <div>
      <h2 class="titulo" style="font-size:22px;margin-bottom:4px;">Confirmar agendamento</h2>
      <p class="sub" style="margin-bottom:0;">
        Preencha para confirmar. Assim que enviar, confirmamos pelo WhatsApp. ‚úÖ
      </p>
    </div>

    <div class="acoes">
      <span class="badge">Agendamento gr√°tis (Google Forms)</span>
      <a class="btn btn-sec" target="_blank" rel="noopener noreferrer"
         href="https://docs.google.com/forms/d/e/1FAIpQLSe5UBt0En3aVGkGw4Oue4cdFE2oCK4YCTcUIjE7ySW7z7Wp4Q/viewform?usp=publish-editor">
        Abrir em tela cheia
      </a>
    </div>
  </div>

  <section class="card">
    <iframe
      src="https://docs.google.com/forms/d/e/1FAIpQLSe5UBt0En3aVGkGw4Oue4cdFE2oCK4YCTcUIjE7ySW7z7Wp4Q/viewform?embedded=true"
      loading="lazy"
      referrerpolicy="no-referrer-when-downgrade">
    </iframe>
  </section>
</main>

<script>
  // ‚úÖ SUA URL DO APPS SCRIPT (ATUALIZADA)
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwluaTuD98C0SAgZmCqBtwZgq1D1rVWkpyyR6XqnmB2WCCoxzLUXixqhenUUwElqjk9/exec";

  const statusBadge = document.getElementById("statusBadge");
  const listaEl = document.getElementById("lista");
  const alertaEl = document.getElementById("alerta");
  const btnAtualizar = document.getElementById("btnAtualizar");

  // ‚úÖ NOVO: filtro por data
  const diaEl = document.getElementById("dia");
  const diaBadge = document.getElementById("diaBadge");
  let allSlots = []; // guarda todos os hor√°rios DISPONIVEIS vindos da API

  function setAlerta(html, tipo="") {
    alertaEl.className = "msg " + (tipo || "");
    alertaEl.innerHTML = html || "";
  }

  // JSONP para GitHub Pages (CORS)
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");

      window[cb] = (data) => {
        try { delete window[cb]; } catch(e){}
        script.remove();
        resolve(data);
      };

      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + cb;

      script.onerror = () => {
        try { delete window[cb]; } catch(e){}
        script.remove();
        reject(new Error("Falha ao carregar do Apps Script."));
      };

      document.body.appendChild(script);
    });
  }

  function ddmmyyyyFromInput(value) {
    // "2026-03-02" -> "02/03/2026"
    if (!value) return "";
    const [y,m,d] = value.split("-");
    return `${d}/${m}/${y}`;
  }

  /***********************
   * ‚úÖ NOVO (ADICIONADO):
   * - bloqueia datas passadas
   * - aviso amig√°vel quando n√£o tem hor√°rios (folga ou agenda cheia)
   ***********************/
  function bloquearDatasPassadas_(){
    const hoje = new Date();
    const y = hoje.getFullYear();
    const m = String(hoje.getMonth()+1).padStart(2,"0");
    const d = String(hoje.getDate()).padStart(2,"0");
    diaEl.min = `${y}-${m}-${d}`;
  }

  function avisarSeFolgaOuSemHorario_(dataStr){
    // O Apps Script j√° remove folgas do list.
    // Aqui s√≥ detecta quando N√ÉO existe nenhum slot nessa data e mostra a msg.
    const tem = allSlots.some(s => s.data === dataStr);
    if(!tem){
      setAlerta(
        `<div class="erro">
          <b>${dataStr}</b> n√£o tem hor√°rios dispon√≠veis.<br>
          Pode ser <b>folga</b> ou agenda cheia. Selecione outra data.
        </div>`,
        "erro"
      );
      statusBadge.textContent = "Nenhum hor√°rio dispon√≠vel";
      return true;
    }
    return false;
  }

  // aplica
  bloquearDatasPassadas_();
  /***********************/

  function renderLista(slotsFiltrados) {
    listaEl.innerHTML = "";
    setAlerta("");

    if (!diaEl.value) {
      statusBadge.textContent = "Selecione uma data";
      setAlerta('<div class="erro">Selecione uma data no calend√°rio para ver os hor√°rios.</div>', "erro");
      return;
    }

    const dataStr = ddmmyyyyFromInput(diaEl.value);
    diaBadge.textContent = dataStr;

    statusBadge.textContent = slotsFiltrados.length
      ? (slotsFiltrados.length + " hor√°rios dispon√≠veis")
      : "Nenhum hor√°rio dispon√≠vel";

    if (!slotsFiltrados.length) {
      setAlerta(`<div class="erro">Sem hor√°rios dispon√≠veis para <b>${dataStr}</b>.</div>`, "erro");
      return;
    }

    for (const s of slotsFiltrados) {
      const div = document.createElement("div");
      div.className = "slot";
      div.innerHTML = `
        <div>
          <b>${s.data} ‚Ä¢ ${s.hora}</b>
          <small>${s.servico} ‚Ä¢ ${s.preco}</small>
        </div>
        <button class="btn" type="button">RESERVAR</button>
      `;

      const btn = div.querySelector("button");
      btn.addEventListener("click", async () => {
        btn.disabled = true;
        btn.textContent = "Reservando‚Ä¶";
        setAlerta("");

        try {
          const res = await jsonp(WEBAPP_URL + "?action=reserve&row=" + encodeURIComponent(s.row));
          if (!res.ok) throw new Error(res.error || "N√£o foi poss√≠vel reservar.");

          // remove do allSlots
          allSlots = allSlots.filter(x => x.row !== s.row);

          // re-render com a data selecionada
          const dataSel = ddmmyyyyFromInput(diaEl.value);
          // ‚úÖ NOVO: avisa se ficou sem hor√°rios (folga/cheio)
          avisarSeFolgaOuSemHorario_(dataSel);

          const filtrados = allSlots.filter(x => x.data === dataSel);
          renderLista(filtrados);

          statusBadge.textContent = "Reservado ‚úÖ";

          setAlerta(
            `<div class="ok"><b>Hor√°rio reservado!</b><br>
            Agora preencha o formul√°rio abaixo para confirmar.<br>
            <span style="opacity:.85">(${s.data} ‚Ä¢ ${s.hora} ‚Äî ${s.servico})</span>
            </div>`,
            "ok"
          );

          window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

        } catch (err) {
          btn.disabled = false;
          btn.textContent = "RESERVAR";
          setAlerta(`<div class="erro">${err.message}</div>`, "erro");
        }
      });

      listaEl.appendChild(div);
    }
  }

  async function carregarHorarios() {
    listaEl.innerHTML = "";
    setAlerta("");
    statusBadge.textContent = "Carregando hor√°rios‚Ä¶";

    try {
      const data = await jsonp(WEBAPP_URL + "?action=list");
      if (!data.ok) throw new Error(data.error || "Erro ao listar hor√°rios.");

      allSlots = data.slots || [];

      // se n√£o escolheu data ainda, s√≥ pede pra escolher
      if (!diaEl.value) {
        statusBadge.textContent = "Selecione uma data";
        setAlerta('<div class="erro">Selecione uma data no calend√°rio para ver os hor√°rios.</div>', "erro");
        return;
      }

      const dataSel = ddmmyyyyFromInput(diaEl.value);

      // ‚úÖ NOVO: avisa se n√£o tem hor√°rios (folga/cheio)
      avisarSeFolgaOuSemHorario_(dataSel);

      const filtrados = allSlots.filter(s => s.data === dataSel);
      renderLista(filtrados);

    } catch (err) {
      statusBadge.textContent = "Erro";
      setAlerta(`<div class="erro">${err.message}</div>`, "erro");
    }
  }

  // eventos
  btnAtualizar.addEventListener("click", carregarHorarios);

  diaEl.addEventListener("change", () => {
    const dataSel = ddmmyyyyFromInput(diaEl.value);
    diaBadge.textContent = dataSel || "Nenhuma data escolhida";

    // ‚úÖ NOVO: avisa se n√£o tem hor√°rios (folga/cheio)
    avisarSeFolgaOuSemHorario_(dataSel);

    const filtrados = allSlots.filter(s => s.data === dataSel);
    renderLista(filtrados);
  });

  // inicia
  diaBadge.textContent = "Nenhuma data escolhida";
  carregarHorarios();
</script>

</body>
</html>
